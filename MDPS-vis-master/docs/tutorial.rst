프로그램 실행 가이드
##############################################

ROI 설정하기
**********************************************

프로그램 실행 이전 ROI를 설정하여 .json 설정파일로 저장하는 과정을 거쳐야 한다. 이 단계에서는 다음 영역을 설정한다.

* **ROI** : 전체 영상에서 변위를 추출할 영역 
* **Track region (housing)** : 하우징 상에서 마커를 추적할 영역
* **Track region (lack bar)** : 랙바가 움직이는 영역
* **PBM ROI** : ROI에서 영상확대를 수행할 영역

다음 명령어를 통해 프로그램을 실행한다.

.. code-block:: bash
    
    $ python ./example/get_roi.py -fname [ROI를 설정할 영상파일] -f [영상파일의 FPS] -o [설정파일이 저장될 경로]

각 옵션은 다음과 같이 설정한다.

* **-fname** : 불러올 영상파일 위치. 예: ./input/1.0_old_dark.mp4
* **-f** : 영상의 FPS를 설정. 양의 정수로 입력하지 않을 경우 에러 발생. 예: 24
* **-o** : 설정 파일이 저장될 경로. 예: ./test.json

프로그램 실행 후 커맨드라인에 표출된 안내를 통해 ROI 설정을 진행한다.

.. image:: img/roi_instruction.png

1단계: ROI 설정
==============================================

전체 영상에서 처리할 부분에 해당하는 부분을 마우스 드래그로 선택하고 ENTER 키를 누른다.

.. image:: img/roi1.png

2단계: 하우징 내 마커 영역 설정
==============================================

하우징에 있는 마커를 대상으로 랙 하우징, 모터 하우징의 순서로 마우스 좌클릭하고, 아래 슬라이드바를 조정하여 충분한 영역을 설정한다.

.. image:: img/roi2.png

3단계: 랙바 이동 영역 설정
==============================================

왼쪽, 오른쪽 랙바 순으로 마우스를 드래그하여 랙바가 움직이는 영역을 설정하고 ENTER 키를 누른다.

.. image:: img/roi3.png

.. image:: img/roi4.png

4단계: 영상확대 영역 설정
==============================================

영상확대를 수행할 영역을 선택한다. 일반적으로 하우징 부분만 영상확대한다.

.. image:: img/roi5.png

설정이 완료되면 다음과 같은 형식의 .json 파일이 생성된다.
이 파일은 다음 **변위 추출하기** 단계의 입력 인자로 쓰이므로 미리 생성해 두어야 한다.
폴더에 미리 만들어진 `old.json` , `new.json` 은 각각 기존, 신규 MDPS 영상에 해당하는 ROI 파일이므로 이를 불러와 사용할 수도 있다.

.. image:: img/json_example.png

변위 추출하기
**********************************************

.json 파일을 만든 후 대상 영상으로부터 변위를 추출할 수 있다.
변위 추출에는 다음 옵션을 설정해야 한다.

* **-fname** : 불러올 영상파일 위치. 예: ./input/1.0_old_dark.mp4
* **-f** : 영상의 FPS를 설정. 양의 정수로 입력하지 않을 경우 에러 발생. 예: 24
* **-skip** : 영상 배속 파라미터. 0이면 영상을 배속하지 않고, 1, 2, 3으로 설정하면 영상을 2, 3, 4배속 시킴. 기본값: 0
* **-o** : 변위 추출 결과가 저장될 폴더. 이미 존재하는 경로일 경우 에러 발생 예: ./output/test_result
* **-fo** : FIR 필터의 크기. 기본값: 14 또는 30
* **-flb** : Lowcut 주파수. 기본값: 0.01
* **-fub** : Highcut 주파수. 기본값: 1
* **-a** : 확대계수. 0인 경우 확대하지 않음 기본값: 0, 1, 2, 3, 4, 5
* **-roi** : ROI 설정파일. 예: ./old.json

예를 들어 기존 MDPS의 변위를 추출하는 작업은 다음과 같이 실행한다.

.. code-block:: bash
    
    $ python ./example/extract_displacement.py -fname ./input/1.0_old_dark.mp4 -f 24 -skip 0 -o ./output/old_test -fo 14 -flb 0.01 -fub 1.0 -a 0 -roi old.json

추출이 완료되면 `-o` 에서 설정한 디렉토리에 세 가지 파일이 생성된다.

* y.csv: 추출된 각 지점의 y방향 (좌우) 변위
* z.csv: 추출된 각 지점의 z방향 (상하) 변위
* test_output.avi: 시각화된 MDPS 영상

csv의 파일의 각 열 (column)은 프레임별 각 마커의 픽셀단위 위치를 나타낸다.
마커가 검출되지 않은 프레임이 있다면 그 시점의 csv 파일 값은 -1로 설정된다.
각 열에 할당된 마커의 순서는 `하우징상 마커 1-하우징상 마커 2-하우징상 마커 3-...-좌측 랙바 마커-우측 랙바 마커` 이다.
하우징상 마커의 나열 순서는 **ROI 설정하기** 의 **2단계: 하우징 내 마커 영역 설정** 단계에서 사용자가 마우스로 클릭한 순서와 같다.

저장되는 변위의 부호는 ROI상 이미지의 좌측 하단을 기준으로 다음 그림과 같이 기록되었다.

.. image:: img/coord.png